<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta name="description" content="富士山麓で起きた野生動物の交通事故の場所と動物の種類のマップです。首都大学東京 渡邉英徳研究室✕富士山アウトドアミュージアム" />
	<meta property="og:image" content="data/screen.jpg" />
	<meta property="og:description" content="富士山麓で起きた野生動物の交通事故の場所と動物の種類のマップです。首都大学東京 渡邉英徳研究室✕富士山アウトドアミュージアム" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
	<title>富士山「動物交通事故死」マップ</title>
	<link rel="SHORTCUT ICON" href="http://shinsai.mapping.jp/favicon.ico">
	<style>
	@import url(Cesium/Widgets/widgets.css);
	</style>
	<link rel="stylesheet" type="text/css" media="all" href="./css/style.css" />
	<link rel="stylesheet" type="text/css" media="all" href="./css/menubutton.css" />
	<link rel="stylesheet" type="text/css" media="all" href="./css/jquery-ui.min.css" />
	<script src="js/jquery-2.1.3.min.js"></script>
	<script src="js/jquery-ui.min.js"></script>
	<script src="js/slidein.js"></script>
	<script src="js/slidein2.js"></script>
	<script src="Cesium/Cesium.js"></script>
	<script src="http://www.google.com/jsapi"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js"></script>
</head>

<body>
	<div class="geocode">
		<form action="javascript:geocode()" class="textbox" />
		<input id="inputtext" class="textbox" type="text" value="" placeholder="地名で検索" />
	</form>
</div>
<div id="svNotAvailable" onclick="fadeInOut(svNotAvailable,0)"></div>
<div id="blackOut">
	<img class="loading" src="data/loading.gif">
</div>
<div id="timeCounter"></div>
<div id="cesiumContainer"></div>
<div id="button" class="general-button">
	<div class="button-content">
		<span class="icon-font">menu</span>
	</div>
</div>
<div id="button2" class="general-button" onclick="help();">
	<div class="button-content">
		<span class="icon-font">help</span>
	</div>
</div>
<div id="button3" class="general-button">
	<div class="button-content">
		<span class="icon-font">paramater</span>
	</div>
</div>
<div id="slide_menu"></div>
<div id="slide_menu2"></div>
<div id="streetView_wrapper">
	<div id="streetView"></div>
	<button class="btn" onclick="svOnOff(0)">×</button>
</div>

<script>

//CCボタンのツールチップ化

$(function() {
	$('.license').tooltip();
});

//スワイプによるスクロール禁止

var cesiumDiv = document.getElementById("cesiumContainer");

function preventScroll(event) {
	event.preventDefault();
}

cesiumDiv.addEventListener("gesturestart", preventScroll, false);
cesiumDiv.addEventListener("gesturechange", preventScroll, false);
cesiumDiv.addEventListener("gestureend", preventScroll, false);

//各種DIV

var streetViewWrapper = document.getElementById("streetView_wrapper");
var cesiumContainer = document.getElementById("cesiumContainer");
blackOutDiv = document.getElementById("blackOut");
svNotAvailable = document.getElementById("svNotAvailable");

//SV呼び出し

var sv = new google.maps.StreetViewService();

//SVエラーメッセージレイヤを隠す

$(function() {
	$(svNotAvailable).hide();
	$('#button4').hide();
});

//停止時間

var stopISO = '2015-12-24T23:59:59+09:00';

//視点作成配列

function viewPoints(_label, _lat, _lng, _heading, _pitch, _range) {
	this.label = _label;
	this.lat = _lat;
	this.lng = _lng;
	this.heading = _heading;
	this.pitch = _pitch;
	this.range = _range;
}

var viewPointsArray=[];
viewPointsArray[0]=new viewPoints("富士山上空",35.360556,138.727778,0,-89,36000);
viewPointsArray[1]=new viewPoints("初期視点",35.360556,138.727778,0,-20,28000);
viewPointsArray[2]=new viewPoints("日本全国",37.95041488123474,137.44348377604837,0,-85,3421711);

//視点メニュー作成

var viewPointChangeMenu = document.getElementById('slide_menu');
var dropDownList = "";

for (var i=0; i<viewPointsArray.length; i++) {
	dropDownList = dropDownList + '<li><a href="#" onclick = "changeViewPoint(' + i + ',' + '3.0);return false;">' + viewPointsArray[i].label + '</a></li>';
}

var viewPointChangeMenuHtml = '<ul class="viewpoint">' + dropDownList + '</ul>';
viewPointChangeMenu.innerHTML = viewPointChangeMenuHtml;

//czml配列作成

function czmlData(_label, _url) {
	this.label = _label;
	this.url = _url;
}

var czmlDataArray=[];
czmlDataArray[0]=new czmlData("ロードキル",'data/czml/animal.czml');

//オーバレイ配列を用意

var overlayDataArray=[];
var openStreetMap=[];

//ビューア初期化	

var viewer = new Cesium.Viewer('cesiumContainer',{
	imageryProvider : new Cesium.ArcGisMapServerImageryProvider({
		url : '//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer',
		enablePickFeatures : false
	}),
	navigationHelpButton : false,
	navigationInstructionsInitiallyVisible : false,
	geocoder:false,
	homeButton:false,
	animation: false,
	sceneModePicker:false,
	baseLayerPicker:false,
	scene3DOnly : true
});

//地形にエンティティが潜るように設定

viewer.scene.globe.depthTestAgainstTerrain = true;

//地形メッシュを設定

var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
	url : '//assets.agi.com/stk-terrain/world',
	requestWaterMask : false,
	requestVertexNormals : false
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;

//地形を強調する際は値を変更

viewer.terrainExaggeration = 1.0;

//フォグ

var fog = new Cesium.Fog();
fog.density = 0.0005;
fog.screenSpaceErrorFactor = 100.0;

//起動シークエンス

$(function() {
	$('.cesium-widget-credits').css('display', 'none');
});

fadeInOut(blackOutDiv,0);

var layers = viewer.scene.imageryLayers;
changeViewPoint(2,0);
setTimeout('groundZero()',1000);

function groundZero(){
	changeViewPoint(0,3);
	openStreetMapLayer();
	setTimeout('landing()',4000);
}

function landing(){
	changeViewPoint(1,3);
	setTimeout('fadeInOut(blackOutDiv,1)',3000);
	setTimeout('loadCzml()',3000);
}

//CZMLロード関数

function loadCzml(){			
	var i = 0;
	var load = setInterval(function(){
		var czmlDataSource = new Cesium.CzmlDataSource();
		var promise = czmlDataSource.load(czmlDataArray[i].url);
		promise.then(function(dataSource) {
			viewer.dataSources.add(dataSource);
			var billboardsIdsLength = czmlDataSource.entities.values.length;
			var i = 0;
			while (i <= billboardsIdsLength){
				var id = i;				
				var entity = czmlDataSource.entities.getById(id);
				if (entity) {
					var scaleByDistance = new Cesium.NearFarScalar(2.0e4,1.2,1.0e5,0.2);
					var translucencyByDistance = new Cesium.NearFarScalar(2.0e4,1.0,2.0e5,0.6);
					var translucencyByDistanceLabel = new Cesium.NearFarScalar(2.0e4,0.9,6.0e4,0.0);
					entity.billboard.scaleByDistance = scaleByDistance;
					entity.billboard.translucencyByDistance = translucencyByDistance;
					entity.polyline.translucencyByDistance = translucencyByDistance;
					entity.label.translucencyByDistance = translucencyByDistanceLabel;
				}
				i++;
			}
		}).otherwise(function(error){
			alert('CZMLデータが読み込めません');
		});
		i++;
		if (i == czmlDataArray.length){
			clearInterval(load);
			setClickEvent();
			viewer.clock.onTick.addEventListener(function(clock){
				var nowTime = viewer.clock.currentTime;
				setTimeout('checkTime()',1000);
			});
			setTimeout('fadeInOut(blackOutDiv,0)',3000);
		}
	}, 200);
}

//地図オーバレイ関数

function openStreetMapLayer (){

	openStreetMap = layers.addImageryProvider(new Cesium.createOpenStreetMapImageryProvider());

//OSMの明度を下げる

openStreetMap.brightness = 0.7;

//OSMの不透明度をデフォルト0に

openStreetMap.alpha = 0;

//オーバーレイ配列作成関数

function overlayData(_label, _value, _overlayObj, _id) {
	this.label = _label;
	this.value = _value;
	this.overlayObj = _overlayObj;
	this.id = _id;
}
overlayDataArray[0]=new overlayData("地図",0,openStreetMap,"range01");

var overlayList = "";
for (var i=0; i<overlayDataArray.length; i++) {
	overlayList = overlayList + '<p class="slide_label">' + overlayDataArray[i].label + '</p><input id="' + overlayDataArray[i].id + '" type="range" min="0" max="33" value="' + overlayDataArray[i].value * 0.33 + '" step="1" oninput="transParent(' + i + ');"/>';
}
var overlayListMenu = document.getElementById('slide_menu2');
overlayListMenu.innerHTML = overlayList;
}

//OSM透明度を変更する関数

function transParent (layer){
	var id = overlayDataArray[layer].id;
	var overlay = overlayDataArray[layer].overlayObj;
	var slider = document.getElementById(id);
	if (slider.value == 0){
		overlay.show = false;	
	} else{
		overlay.show = true;
		overlay.alpha = slider.value * 0.03;
	}
}

//視点移動する関数

function changeViewPoint(num, delay) {
	var newLat = viewPointsArray[num].lat;
	var newLng = viewPointsArray[num].lng;
	var newHeading = Cesium.Math.toRadians(viewPointsArray[num].heading);
	var newPitch = Cesium.Math.toRadians(viewPointsArray[num].pitch);
	var newRange = viewPointsArray[num].range;
	
	var center = Cesium.Cartesian3.fromDegrees(newLng, newLat);
	var boundingSphere = new Cesium.BoundingSphere(center, newRange);
	var headingPitchRange = new Cesium.HeadingPitchRange(newHeading, newPitch, newRange);
	
	viewer.camera.constrainedAxis = Cesium.Cartesian3.UNIT_Z;
	viewer.camera.flyToBoundingSphere(boundingSphere,{
		duration : delay,
		offset : headingPitchRange,
		easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
	});
}

//ジオコード関数

function geocode() {
	var geocoder = new google.maps.Geocoder();
	var input = document.getElementById('inputtext').value;
	geocoder.geocode(
		{ address:input },

		function( results, status ) {
			if( status == google.maps.GeocoderStatus.OK ) {
				var viewportObj = results[0].geometry.viewport;
				var southNorth = viewportObj[Object.keys(viewportObj)[0]];
				var westEast = viewportObj[Object.keys(viewportObj)[1]];

				var south = southNorth[Object.keys(southNorth)[0]];
				var north = southNorth[Object.keys(southNorth)[1]];
				var west = westEast[Object.keys(westEast)[0]];
				var east = westEast[Object.keys(westEast)[1]];		
				var rectangle = Cesium.Rectangle.fromDegrees(west, south, east, north);
				viewer.camera.flyTo({
					destination : rectangle,
					easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
				});
			} else {
				alert('見つかりません');
			}
		} 
		);
}

//ダブルクリックでストビューを表示する関数

function setClickEvent(){
	var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
	handler.setInputAction(function(click) {
		var pickedObject = viewer.scene.pick(click.position);
		if (Cesium.defined(pickedObject) && (pickedObject != "")) {
			svOnOff(1);
			delete svp;
			var position = pickedObject.primitive._position;
			var cart = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position);
			var latlng = new google.maps.LatLng(Cesium.Math.toDegrees(cart.latitude), Cesium.Math.toDegrees(cart.longitude));
			sv.getPanoramaByLocation(latlng, 50, function (data, status) {
				if (status != google.maps.StreetViewStatus.OK) {
					svNotAvailable.innerHTML = '<p class="errorMessage">この場所のストリートビューは利用できません</p>';
					fadeInOut(svNotAvailable,1);
					setTimeout('fadeInOut(svNotAvailable,0)',1500);
				} else {
					svp = new google.maps.StreetViewPanorama(
						document.getElementById("streetView"),{
							position : latlng,
							zoomControl : false,
							panControl : false,
							addressControl : false,
							fullscreenControl : false
						});
				}
			});
		} else {
			svOnOff(0);
		}
	}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

//時間チェック

function checkTime() {
	viewer.clock.multiplier = 3000 * 60 * 60;

	var now = viewer.clock.currentTime;
	var stop = Cesium.JulianDate.fromIso8601(stopISO);
	var nowAndCurrent = Cesium.JulianDate.compare(now, stop);
	if (nowAndCurrent > 0){
		viewer.clock.shouldAnimate = false;
	}

	var nowJST = new Cesium.JulianDate;
	Cesium.JulianDate.addHours(now, 9, nowJST);
	var nowIso = Cesium.JulianDate.toIso8601(nowJST);
	thisTime = '3.' + nowIso.substr(8,2) + '.' + nowIso.substr(11,2);

	var nowDate = Cesium.JulianDate.toDate(now);
	var y = nowDate.getFullYear();
	var m = nowDate.getMonth() + 1;
	var d = nowDate.getDate();
	if (m < 10) {
		m = '0' + m;
	}
	if (d < 10) {
		d = '0' + d;
	}
	var displayTime = y + '年' + m + '月' + d + '日';
	timeCounter(displayTime);
}

//カウンター表示

function timeCounter(displayTime){
	var timeCounter = document.getElementById("timeCounter");
	timeCounter.innerHTML = '<p class="timeCounter">' + displayTime +'</p>';
}

//ヘルプ

function help(){
	window.open('https://github.com/hwtnv/cesiumGitHubPages');
}

//DIVのフェードイン・アウト関数

function fadeInOut(layer,param) {
	if (param == 0){
		$(function() {
			$(layer).fadeOut("slow");
		});
		delete layer;
		viewer.trackedEntity = undefined;
	} else {
		$(function() {
			$(layer).fadeIn("slow");
		});
	} 
}

//ストビューDIVのフェードアウト関数

function svOnOff(param) {
	if (param == 0){
		streetViewWrapper.style.display = "none";
		delete svp;
	} else {
		streetViewWrapper.style.display = "block";
	}
}

</script>

<div class="license">
	<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="首都大学東京 渡邉英徳研究室✕富士山アウトドアミュージアム 作『富士山「動物交通事故死」マップ』はクリエイティブ・コモンズ 表示 - 非営利 - 継承 4.0 国際 ライセンスで提供されています。"><img alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"
		/></a>
		<br /><a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/hwtnv/cesiumGitHubPages" property="cc:attributionName"
		rel="cc:attributionURL">首都大学東京 渡邉英徳研究室✕富士山アウトドアミュージアム</a> 作『<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Dataset"
		property="dct:title" rel="dct:type">富士山「動物交通事故死」マップ</span>』は<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">クリエイティブ・コモンズ 表示 - 非営利 - 継承 4.0 国際 ライセンス</a>で提供されています。
	</div>
</body>

</html>